## ADDED Requirements

### Requirement: 积分系统
系统 SHALL支持用户通过积分获取付费资源，并记录所有积分变动。

#### Scenario: 查看积分余额
- **WHEN** 登录用户访问用户中心
- **AND** 点击"我的积分"标签
- **THEN** 显示当前积分余额
- **AND** 显示最近积分交易记录
- **AND** 积分余额高亮显示

#### Scenario: 邀请注册获得积分
- **WHEN** 用户A通过邀请链接邀请用户B注册
- **AND** 用户B完成注册
- **AND** 验证邀请关系有效
- **THEN** 为用户A添加邀请奖励积分（默认10积分）
- **AND** 记录积分来源为"邀请奖励"
- **AND** 记录被邀请用户的ID和注册时间
- **AND** 用户A收到积分到账通知

#### Scenario: 下载付费资源扣减积分
- **WHEN** 用户点击付费资源的下载按钮
- **AND** 资源设置了积分价格
- **AND** 用户积分充足
- **THEN** 自动扣除资源设定的积分价格
- **AND** 记录扣减类型为"资源下载"
- **AND** 记录资源ID和标题
- **AND** 显示剩余积分

#### Scenario: 免费资源不扣积分
- **WHEN** 用户点击免费资源的下载按钮
- **AND** 资源积分为0
- **THEN** 直接跳转到网盘链接
- **AND** 不扣减积分
- **AND** 仍然增加下载次数

#### Scenario: 积分不足提示
- **WHEN** 用户积分不足以下载资源
- **AND** 用户点击下载按钮
- **THEN** 显示提示"积分不足，需要XX积分"
- **AND** 不扣除积分
- **AND** 提供获取积分的提示（邀请新用户可获得10积分）

### Requirement: 积分交易记录
系统 SHALL记录所有积分变动的详细信息。

#### Scenario: 积分支出记录
- **WHEN** 用户下载付费资源
- **THEN** 在积分交易记录中创建一条记录
- **AND** 记录类型：支出
- **AND** 记录积分数值：负数
- **AND** 记录交易时间：精确到秒
- **AND** 记录关联资源：ID、标题、链接
- **AND** 记录交易状态：成功/失败

#### Scenario: 积分收入记录
- **WHEN** 用户获得积分（邀请奖励、管理员添加等）
- **THEN** 创建收入记录
- **AND** 记录类型：收入
- **AND** 记录积分数值：正数
- **AND** 记录交易时间
- **AND** 记录积分来源：邀请奖励/管理员添加/其他
- **AND** 邀请奖励时记录被邀请用户的ID

#### Scenario: 查看交易记录
- **WHEN** 用户访问积分记录页面
- **THEN** 分页显示所有交易记录
- **AND** 按时间倒序排列（最新的在前）
- **AND** 每条记录显示：时间、类型、积分变化、余额、备注

#### Scenario: 积分记录筛选
- **WHEN** 用户在积分记录页面
- **AND** 选择筛选条件（时间范围、类型：收入/支出）
- **THEN** 仅显示符合条件的历史记录

### Requirement: 积分管理
系统 SHALL允许管理员查看和管理用户积分。

#### Scenario: 管理员查看所有用户积分
- **WHEN** 管理员访问管理员后台
- **AND** 进入用户管理页面
- **THEN** 显示所有用户的积分余额
- **AND** 可以按积分余额排序
- **AND** 可以搜索特定用户的积分

#### Scenario: 管理员为用户添加积分
- **WHEN** 管理员在用户详情页点击"添加积分"
- **AND** 输入积分数值和备注信息
- **AND** 确认操作
- **THEN** 为用户添加积分
- **AND** 在用户交易记录中创建管理员添加记录
- **AND** 记录管理员操作人和备注信息

#### Scenario: 管理员扣除用户积分
- **WHEN** 管理员在用户详情页点击"扣除积分"
- **AND** 输入积分数值和原因
- **AND** 确认操作
- **AND** 用户积分充足
- **THEN** 扣除用户积分
- **AND** 在交易记录中创建管理员扣除记录

#### Scenario: 管理员无法扣除超额积分
- **WHEN** 管理员尝试扣除超过用户余额的积分
- **THEN** 系统提示"扣除积分不能超过用户当前余额"
- **AND** 操作被拒绝

### Requirement: 免费资源
系统 SHALL允许管理员将某些资源标记为免费，无需积分即可下载。

#### Scenario: 标记资源为免费
- **WHEN** 管理员编辑资源信息
- **AND** 将积分价格设为0或勾选"免费"选项
- **AND** 保存资源
- **THEN** 资源标记为免费
- **AND** 下载按钮显示"免费下载"

#### Scenario: 下载免费资源
- **WHEN** 用户点击免费资源的下载按钮
- **AND** 资源积分为0
- **THEN** 直接跳转到网盘链接
- **AND** 不扣除积分
- **AND** 仍然增加下载次数

#### Scenario: 免费资源统计
- **WHEN** 显示资源列表
- **AND** 积分价格为0的资源显示"免费"标记
- **AND** 使用绿色图标突出显示

#### Scenario: 管理员设置资源积分
- **WHEN** 管理员编辑资源信息
- **AND** 设置积分数值（0或正整数）
- **AND** 保存资源
- **THEN** 资源价格更新生效
- **AND** 用户下载时按新价格执行

#### Scenario: 管理员批量设置积分
- **WHEN** 管理员在资源列表选择多个资源
- **AND** 点击"批量设置积分"
- **AND** 输入统一的积分数值
- **AND** 确认操作
- **THEN** 所有选中资源的积分价格更新

### Requirement: 积分验证
系统 SHALL验证积分操作的正确性。

#### Scenario: 下载前积分余额验证
- **WHEN** 用户尝试下载付费资源
- **THEN** 系统检查用户当前积分
- **AND** 确保积分充足才允许下载
- **AND** 防止并发下载导致的积分不足

#### Scenario: 积分扣减事务性
- **WHEN** 用户下载资源
- **AND** 系统扣除积分
- **AND** 网络中断或系统故障
- **THEN** 积分扣减操作回滚
- **AND** 不会产生重复扣减

#### Scenario: 积分不能为负数
- **WHEN** 任何原因导致积分变动
- **THEN** 积分余额永远不会小于0
- **AND** 如果计算结果为负数，操作被拒绝

### Requirement: 积分奖励机制
系统 SHALL提供积分奖励机制。

#### Scenario: 邀请用户奖励积分
- **WHEN** A用户邀请B用户注册
- **AND** B用户完成注册
- **AND** 系统检测到邀请关系
- **THEN** 为A用户添加邀请奖励积分（默认10积分）
- **AND** 在交易记录中标记为"邀请奖励"
- **AND** 记录被邀请用户的ID和注册时间

#### Scenario: 邀请奖励规则配置
- **WHEN** 管理员访问积分规则配置页面
- **AND** 设置邀请奖励积分数值（默认10）
- **AND** 保存配置
- **THEN** 新的邀请奖励规则立即生效
- **AND** 已有邀请记录不受影响

#### Scenario: 用户查看邀请统计
- **WHEN** 用户访问用户中心
- **AND** 点击"我的邀请"标签
- **THEN** 显示邀请统计
- **AND** 包括：总邀请人数、成功邀请人数、累计获得积分
- **AND** 显示邀请列表（含用户名、注册时间、奖励状态）

#### Scenario: 管理员查看邀请排行榜
- **WHEN** 管理员访问积分统计页面
- **AND** 选择"邀请排行榜"
- **THEN** 显示邀请用户最多的Top10
- **AND** 包括：用户名、邀请人数、累计奖励积分

#### Scenario: 重复邀请检测
- **WHEN** 用户尝试使用多个邀请码注册
- **AND** 系统检测到关联关系
- **THEN** 只使用第一个有效的邀请关系
- **AND** 防止重复奖励积分

#### Scenario: 积分规则管理
- **WHEN** 管理员修改积分规则
- **AND** 更新邀请奖励数量
- **AND** 保存配置
- **THEN** 新注册的邀请生效
- **AND** 已有邀请记录保持不变