## 背景和约束
资源分享平台需要支持多种资源类型的分享和管理，核心约束包括：
- 单体架构，不使用前后端分离
- Go 语言开发，最小化资源占用
- 支持 SQLite/MySQL 双数据库
- Redis 可选且必须支持禁用
- 响应式设计，支持桌面和移动端
- 所有代码使用中文注释

## 目标与非目标
### 目标
- 构建完整可运行的资源分享平台
- 实现用户、资源、积分、管理员等核心功能
- 提供美观大气的响应式界面
- 保证代码健壮性、可维护性和可扩展性
- 完整的测试覆盖和文档

### 非目标
- 不实现分布式架构
- 不实现复杂的微服务
- 不支持第三方 OAuth 登录（使用本地认证）
- 不实现文件服务器（仅存储网盘链接）
- 不实现复杂的全文搜索（使用数据库 LIKE 查询）

## 技术决策

### 1. Web 框架选择
**决策**: 使用原生 Go `net/http` 或轻量级 Gin 框架
**理由**:
- 原生 http: 最小的依赖和资源占用
- Gin: 更简洁的 API 和中间件支持，提升开发效率
**权衡**: 选择 Gin 以提高开发效率，资源占用在可接受范围内

### 2. 数据库选择
**决策**: 使用 GORM ORM，支持 SQLite（开发）和 MySQL 9（生产）
**理由**:
- GORM 成熟稳定，开发效率高
- SQLite 无需额外配置，适合开发和测试
- MySQL 9 适合生产环境，支持并发，性能和功能全面升级
**权衡**: 通过配置切换数据库，无需修改业务代码

### 3. 缓存策略
**决策**: Redis 作为可选缓存，支持禁用
**理由**:
- 会话存储: 使用 Redis 存储用户会话（可选）
- 数据缓存: 缓存分类列表、热门资源等（可选）
- 如果禁用 Redis，程序回退到内存存储
**权衡**: 通过配置控制 Redis 使用，默认为禁用状态

### 4. 会话管理
**决策**: Session-based 认证，使用 Gin's session 中间件
**理由**:
- 单体架构适合 Session 模式
- 简单的会话管理，最小依赖
- 支持 Redis 或内存存储
**权衡**: 比 JWT 更简单，符合单体架构需求

### 5. 前端技术
**决策**: Go HTML Template + Bootstrap/Tailwind CSS + 原生 JavaScript
**理由**:
- Go Template 与后端集成紧密
- Bootstrap/Tailwind 快速构建响应式 UI
- 原生 JavaScript 无需额外依赖
**权衡**: 开发效率 vs 现代化程度，选择效率

### 6. 项目结构
**决策**: 采用分层架构 + 面向领域的设计
```
cmd/server          # 应用入口
internal/
  config            # 配置管理
  handler           # HTTP 处理器（Controller）
  service           # 业务逻辑
  repository        # 数据访问（Repository）
  model             # 数据模型
  middleware        # 中间件
web/
  templates         # HTML 模板
  static            # 静态资源
pkg/
  utils             # 工具函数
```
**理由**:
- 清晰的职责分离
- 易于测试和维护
- 符合 Go 最佳实践

### 7. 错误处理
**决策**: 返回结构化错误，包含错误码和消息
**理由**:
- 统一的错误处理
- 便于调试和日志记录
- 用户友好的错误信息
**实现**:
```go
type AppError struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
    Err     error  `json:"-"`
}
```

### 8. 数据校验
**决策**: 使用 Go validator 进行数据校验
**理由**:
- 简单高效的校验
- 与 Gin 集成良好
- 支持自定义校验规则
**权衡**: 依赖增加但提升开发效率

### 9. 日志系统
**决策**: 使用 Go 标准 log 包或 logrus
**理由**:
- 标准库: 无依赖，最小占用
- logrus: 结构化日志，支持级别
**权衡**: 选择 logrus 以获得更好的日志格式

### 10. MySQL 9 优化策略
**决策**: 利用 MySQL 9 的新特性进行数据库优化
**理由**:
- 原生 JSON 支持: 直接在数据库中存储和处理 JSON 数据，减少应用层解析
- 改进的全文搜索: 利用 MySQL 9 的增强搜索功能，无需外部搜索引擎
- 更好的索引优化: 使用 MySQL 9 的自适应哈希索引提升查询性能
- 原生复制功能: 方便后期读写分离扩展
**实现**:
```sql
-- 示例: 使用原生 JSON 存储资源标签
ALTER TABLE resources ADD COLUMN tags JSON;
-- 使用 MySQL 9 的 JSON 查询功能
SELECT * FROM resources WHERE JSON_CONTAINS(tags, '"热门"');
```

## 风险和权衡

### 性能风险
**风险**: 单体架构在高并发下可能成为瓶颈
**缓解**:
- MySQL 9 连接池优化
- 适当使用缓存
- 代码性能优化
- 后期可考虑读写分离

### 扩展性风险
**风险**: 后期功能扩展可能困难
**缓解**:
- 采用分层架构，降低耦合
- 接口抽象，预留扩展点
- 清晰的模块划分

### 依赖风险
**风险**: Redis 等外部依赖增加复杂度
**缓解**:
- 所有外部依赖都是可选的
- 提供禁用配置和回退方案
- 默认配置最小依赖

### 数据安全风险
**风险**: 用户数据泄露
**缓解**:
- 密码加密存储
- SQL 注入防护（使用 ORM）
- XSS 防护（模板自动转义）
- CSRF 保护

## 迁移计划

### 第一阶段: 基础架构
1. 创建项目结构
2. 配置数据库模型
3. 实现基础中间件

### 第二阶段: 核心功能
1. 用户认证系统
2. 资源管理系统
3. 分类系统

### 第三阶段: 高级功能
1. 积分系统
2. 广告管理
3. 管理员后台

### 第四阶段: 完善和测试
1. 前端优化
2. 全面测试
3. 文档完善

## 开放问题

### 1. 网盘链接验证
是否需要验证网盘链接的有效性？
- 选项 A: 定期检查链接有效性
- 选项 B: 只在下载时验证
- 决策: 暂时不实现自动验证，用户举报后管理员处理

### 2. 积分获取方式
用户如何获取积分？
- 选项 A: 注册赠送
- 选项 B: 邀请用户奖励
- 选项 C: 管理员手动添加
- 决策: 实现 B 和 C，A 可选，邀请奖励为主

### 3. 搜索功能
是否需要全文搜索？
- 选项 A: 数据库 LIKE 查询（简单）
- 选项 B: Elasticsearch（复杂但强大）
- 决策: 初期使用 LIKE，后期可扩展

### 4. 图片处理
资源缩略图如何处理？
- 选项 A: 不处理，存储图片链接
- 选项 B: 自动生成缩略图
- 决策: 选择 A，减少复杂度

### 5. API 设计
是否需要提供 REST API？
- 选项 A: 仅 Web 界面
- 选项 B: 提供 API 供第三方调用
- 决策: 初期仅 Web 界面，API 作为扩展功能

### 6. 资源导入方式
如何批量导入资源？
- 选项 A: 仅管理员手动添加
- 选项 B: 支持爬虫抓取
- 选项 C: 支持 Excel 模板导入
- 决策: 选择 B 和 C，管理员可配置爬虫策略，批量导入资源

### 7. 用户上传权限
普通用户是否可以上传资源？
- 选项 A: 默认允许所有用户上传
- 选项 B: 默认禁止，需管理员开启
- 决策: 选择 B，避免垃圾资源，提升内容质量

### 8. 爬虫策略
如何实现爬虫抓取？
- 选项 A: 基于规则的定向抓取
- 选项 B: 通用搜索引擎集成
- 决策: 选择 A，使用 colly 框架实现可配置的站点抓取

### 9. Excel 导入格式
Excel 模板需要包含哪些字段？
- 选项 A: 最小字段集（标题、链接）
- 选项 B: 完整字段集（标题、描述、分类、价格等）
- 决策: 选择 B，提供灵活的导入模板

### 10. 邀请奖励机制
如何实现邀请注册奖励？
- 选项 A: 每个邀请成功奖励固定积分
- 选项 B: 根据被邀请用户活跃度奖励积分
- 选项 C: 多级邀请奖励（上家也可获得积分）
- 决策: 选择 A，简单直接，每个邀请成功奖励10积分

### 11. 资源积分价格策略
资源积分价格如何设置？
- 选项 A: 默认免费，管理员可设置付费
- 选项 B: 默认付费，管理员可设为免费
- 决策: 选择 A，符合用户习惯，大部分资源免费

### 12. 邀请码生成机制
邀请链接如何生成？
- 选项 A: 使用用户ID生成邀请码
- 选项 B: 使用UUID生成唯一邀请码
- 选项 C: 生成短链接
- 决策: 选择 B，生成唯一邀请码，便于统计和管理

### 13. 积分规则配置
积分奖励规则如何管理？
- 选项 A: 写死代码中
- 选项 B: 数据库配置，可动态修改
- 决策: 选择 B，管理员可在后台配置奖励积分数量

### 14. 访问统计方式
如何记录用户访问数据？
- 选项 A: 实时记录每次访问
- 选项 B: 定时聚合统计
- 选项 C: 抽样记录
- 决策: 选择 A，实时记录访问日志，便于详细分析

### 15. Dashboard统计时间范围
统计数据的最小粒度是什么？
- 选项 A: 按天统计
- 选项 B: 按小时统计
- 决策: 选择 A，按天统计，支持按月、季度查看汇总

### 16. IP黑名单机制
如何实现IP黑名单？
- 选项 A: 应用层检查，访问时查询数据库
- 选项 B: 中间件过滤，提前拦截
- 决策: 选择 B，在中间件层检查，提高效率

### 17. 账户禁止机制
用户账户状态如何管理？
- 选项 A: 在用户表中添加状态字段
- 选项 B: 单独的账户状态表
- 决策: 选择 A，在用户表中添加 status 字段（正常/禁止）

### 18. 统计数据存储
统计数据如何存储和查询？
- 选项 A: 每次查询实时计算
- 选项 B: 预聚合存储
- 决策: 选择 B，定时聚合统计数据，提高查询效率